## Files indexer

### Quickstart

Index 1000 Genomes files from the default [manifest tsv file](../dataset_config/1000_genomes/files_manifest.tsv).
into an Elasticsearch container.

* If `~/.config/gcloud/application_default_credentials.json` doesn't exist,
create it by running `gcloud auth application-default login` (only needed if
manifest file is on GCS).
* From the `files` directory, run: `docker-compose up --build`
* View Elasticsearch index:
  ```
  http://localhost:9200/_cat/indices?v
  http://localhost:9200/1000_genomes/_search?pretty=true
  ```

If you want to run the Data Explorer UI on this dataset, follow the instructions
below. Note that you will have to reindex the data into an Elasticsearch
container from the [data-explorer repo](https://github.com/DataBiosphere/data-explorer/).

### Index a custom dataset locally

Each row in the file refers to a single sample
and must contain `participant_id` and `sample_id` columns. The sample is stored
as a [nested](https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)
field on the document and `participant_id` is used as the primary
key. [See here](https://github.com/DataBiosphere/data-explorer-indexers#overview)
for background on primary key. Any additional columns in the manifest file
will be indexed as metadata fields on the sample. Columns containing paths to
known genomic file types will also have a `_has_<FILE_TYPE>` field set, where
`FILE_TYPE` is one of `BAM`, `CRAM`, `FASTQ`, or `VCF`.

* If `~/.config/gcloud/application_default_credentials.json` doesn't exist,
create it by running `gcloud auth application-default login`.
* Setup config files.
  * Create `dataset_config/<my dataset>`. Copy `dataset_config/template/*` to this directory.
  * Edit config files; instructions are in the files
* Run Elasticsearch:
  * If you intend to run the [Data Explorer UI](https://github.com/DataBiosphere/data-explorer/)
  after this, run inside the *data-explorer* repo:
    ```
    docker-compose up -d elasticsearch
    ```
  * If you do not intend to run the Data Explorer UI after this, and just want
  to inspect the index in Elasticsearch, run inside this repo from the
  `files` directory:
    ```
    docker-compose up -d elasticsearch
    ```
* Run the indexer. From `files` directory, run:
  ```
  DATASET_CONFIG_DIR=dataset_config/<my dataset> docker-compose up --build indexer
  ```
* View Elasticsearch index:
  ```
  http://localhost:9200/_cat/indices?v
  http://localhost:9200/MY_DATASET/_search?pretty=true
  ```
* Optionally, [bring up a local Data Explorer UI](https://github.com/DataBiosphere/data-explorer/blob/5441559c57ab7a2e0813e8e4fe7e19a9394f1bdf/README.md#run-local-data-explorer-with-a-specific-dataset).

### Generating `requirements.txt`

`requirements.txt` is autogenerated from `requirements-to-freeze.txt`. The
latter lists only direct dependencies. To regenerate run from `files` directory:

```
virtualenv ~/virtualenv/indexer-files
source ~/virtualenv/indexer-files/bin/activate
pip install -r requirements-to-freeze.txt
pip freeze | sort -f | sed 's/^indexer-util.*/\.\/indexer_util/g' > requirements.txt
deactivate
```
